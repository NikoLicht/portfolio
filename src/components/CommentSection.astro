---
// Astro server-side
import Comment from "./Comment.astro";
const { slug } = Astro.props;

// Replace with your deployed API Gateway endpoint:
const commentsApiUrl = "https://2r1id8b5i3.execute-api.eu-north-1.amazonaws.com/comments";
---
<section class="comment-section">
  <h3>Comments</h3>

  <div id="comment-list" class="comment-list">
    <p>Loading commentsâ€¦</p>
  </div>

  <form id="comment-form" class="comment-form">
    <input name="name" placeholder="Your name" required />
    <textarea name="comment" placeholder="Your comment" required></textarea>
    <input type="hidden" name="slug" value={slug} />
    <button type="submit">Send</button>
  </form>


  <script type="module">
    const form = document.getElementById("comment-form");
    const commentList = document.getElementById("comment-list");
    const apiUrl = `${"https://2r1id8b5i3.execute-api.eu-north-1.amazonaws.com/comments"}?slug=${encodeURIComponent(form.slug.value)}`;
    console.log(encodeURIComponent(form.slug.value));

    async function loadComments() {
      try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        commentList.innerHTML = "";
        if (data && data.comments && data.comments.length > 0) {
          data.comments.forEach(c => {
            const div = document.createElement("div");
            div.innerHTML = `<strong>${c.name}</strong>: ${c.content}`;
            commentList.appendChild(div);
          });
        } else {
          commentList.innerHTML = "<p>No comments yet.</p>";
        }
      } catch (err) {
        commentList.innerHTML = "<p>Failed to load comments.</p>";
        console.error(err);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = form.name.value;
      const content = form.comment.value;
      const slug = form.slug.value;

      try {
        const res = await fetch("https://2r1id8b5i3.execute-api.eu-north-1.amazonaws.com/comments", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ name, content, articleSlug: slug })
        });

        const result = await res.json();
        if (result.success) {
          form.reset();
          await loadComments();
        } else {
          alert("Failed to post comment.");
        }
      } catch (err) {
        console.error(err);
        alert("Error submitting comment.");
      }
    });

    loadComments();
  </script>
</section>

<style>
.comment-section {
  margin-top: 2em;
}
.comment-form {
  display: flex;
  flex-direction: column;
  gap: 0.5em;
  margin-bottom: 1.5em;
}
.comment-form input,
.comment-form textarea {
  font-size: 1em;
  padding: 0.5em;
  border-radius: 0.3em;
  border: 1px solid #ccc;
}
.comment-form button {
  width: fit-content;
  padding: 0.5em 1.2em;
  border-radius: 0.3em;
  border: none;
  background: #333;
  color: #fff;
  cursor: pointer;
}
.comment-list {
  display: flex;
  flex-direction: column;
  gap: 0.5em;
}
</style>
